# ПЛАН ТЕСТИРОВАНИЯ РЕФАКТОРИНГА СИСТЕМЫ ЛОГИРОВАНИЯ

**Версия: V2.4.103 (2025.11.04)**  
**Проект: FSA-AstraInstall**  
**Цель: Проверка работы централизованной системы логирования через DualStreamLogger**

---

## ОБЩАЯ СТРАТЕГИЯ ТЕСТИРОВАНИЯ

Проверить все компоненты рефакторинга:
1. ✅ DualStreamLogger инициализируется корректно
2. ✅ universal_print() работает как переопределение builtins.print
3. ✅ RAW и ANALYSIS потоки работают независимо
4. ✅ GUI читает из буферов DualStreamLogger
5. ✅ Режимы отображения ("raw", "analysis", "both") работают
6. ✅ Автопрокрутка терминала работает корректно
7. ✅ Воспроизведение лога загружается в буферы
8. ✅ Файлы логов создаются и заполняются
9. ✅ Метки времени добавляются автоматически
10. ✅ TerminalRedirector перехватывает sys.stdout/stderr

---

## ЭТАП 1: БАЗОВОЕ ТЕСТИРОВАНИЕ ИНИЦИАЛИЗАЦИИ

### Тест 1.1: Запуск GUI и проверка DualStreamLogger

**Шаги:**
1. Запустить GUI: `python3 launch_gui_macos.py`
2. Проверить консольный вывод при запуске:
   - Должно быть сообщение: `[DUAL_STREAM] OK: DualStreamLogger создан и запущен`
   - Должно быть сообщение: `[DUAL_STREAM] OK: Тестовые записи добавлены в RAW-поток`
   - Должны быть указаны пути к RAW и ANALYSIS лог-файлам

**Ожидаемый результат:**
- ✅ DualStreamLogger инициализирован
- ✅ Тестовые записи в RAW-потоке
- ✅ Пути к лог-файлам отображаются

### Тест 1.2: Проверка создания лог-файлов

**Шаги:**
1. После запуска GUI проверить наличие файлов:
   - `*_raw.log` (RAW-поток)
   - `*_analysis.log` (ANALYSIS-поток, основной лог)

**Ожидаемый результат:**
- ✅ Оба файла создаются
- ✅ Файлы не пустые (содержат тестовые записи)
- ✅ В файлах есть метки времени `[YYYY-MM-DD HH:MM:SS.mmm]`

**Команда для проверки:**
```bash
cd /Volumes/FSA-PRJ/Project/FSA-AstraInstall
ls -lh *.log | tail -5
head -5 *_raw.log
head -5 *_analysis.log
```

---

## ЭТАП 2: ТЕСТИРОВАНИЕ universal_print()

### Тест 2.1: Стандартный print() перенаправляется

**Шаги:**
1. В GUI открыть окно терминала
2. Выполнить простую операцию (например, обновление репозиториев)
3. Проверить, что стандартные `print()` попадают в ANALYSIS поток

**Ожидаемый результат:**
- ✅ Все сообщения имеют метки времени
- ✅ Сообщения отображаются в терминале GUI
- ✅ Сообщения записываются в `*_analysis.log`

### Тест 2.2: Прямой вызов universal_print() с параметрами

**Что проверить:**
- `universal_print("test", stream='raw')` → попадает в RAW поток
- `universal_print("test", stream='analysis')` → попадает в ANALYSIS поток
- `universal_print("test", level='ERROR')` → имеет уровень ERROR
- `universal_print("test", gui_log=True)` → отображается в GUI логе

**Как проверить:**
Добавить тестовые вызовы в код или проверить через существующие вызовы:
- `TerminalRedirector.write()` → должен использовать `stream='raw'`
- `UniversalProcessRunner.log_info()` → должен использовать `stream='analysis'`

---

## ЭТАП 3: ТЕСТИРОВАНИЕ RAW И ANALYSIS ПОТОКОВ

### Тест 3.1: RAW поток (перехват sys.stdout/stderr)

**Шаги:**
1. Запустить операцию обновления системы (например, `apt-get update`)
2. Проверить, что вывод `apt-get` попадает в RAW поток
3. Проверить файл `*_raw.log` - должны быть строки без обработки

**Ожидаемый результат:**
- ✅ RAW поток содержит необработанный вывод процессов
- ✅ Метки времени добавлены автоматически
- ✅ Сообщения в формате: `[timestamp] [level] message`

### Тест 3.2: ANALYSIS поток (системные сообщения)

**Шаги:**
1. Выполнить операцию, которая использует `log_info()`, `log_error()`, `log_warning()`
2. Проверить, что сообщения попадают в ANALYSIS поток
3. Проверить файл `*_analysis.log`

**Ожидаемый результат:**
- ✅ ANALYSIS поток содержит структурированные сообщения
- ✅ Уровни логов (INFO/ERROR/WARNING) присутствуют
- ✅ Метки времени добавлены автоматически

---

## ЭТАП 4: ТЕСТИРОВАНИЕ GUI ИНТЕГРАЦИИ

### Тест 4.1: Чтение из буферов DualStreamLogger

**Шаги:**
1. Запустить GUI
2. Открыть окно терминала
3. Выполнить операцию, которая генерирует сообщения
4. Проверить, что терминал обновляется

**Ожидаемый результат:**
- ✅ Терминал отображает сообщения из буферов
- ✅ Сообщения имеют метки времени
- ✅ Обновление происходит автоматически (при включенной автопрокрутке)

### Тест 4.2: Режим отображения "raw"

**Шаги:**
1. В GUI переключить режим терминала на "RAW"
2. Выполнить операцию (например, `apt-get update`)
3. Проверить содержимое терминала

**Ожидаемый результат:**
- ✅ Отображаются только сообщения из RAW потока
- ✅ Видны необработанные сообщения от процессов
- ✅ Метки времени присутствуют

### Тест 4.3: Режим отображения "analysis"

**Шаги:**
1. В GUI переключить режим терминала на "ANALYSIS"
2. Выполнить операцию
3. Проверить содержимое терминала

**Ожидаемый результат:**
- ✅ Отображаются только сообщения из ANALYSIS потока
- ✅ Видны структурированные системные сообщения
- ✅ Уровни логов (INFO/ERROR/WARNING) присутствуют

### Тест 4.4: Режим отображения "both" с сортировкой по времени

**Шаги:**
1. В GUI переключить режим терминала на "BOTH"
2. Выполнить операцию, которая генерирует и RAW, и ANALYSIS сообщения
3. Проверить, что сообщения отсортированы по времени

**Ожидаемый результат:**
- ✅ Отображаются сообщения из обоих потоков
- ✅ Сообщения отсортированы по меткам времени (хронологически)
- ✅ RAW и ANALYSIS сообщения чередуются по времени

**Как проверить сортировку:**
- Добавить задержку между RAW и ANALYSIS сообщениями
- Проверить, что они отображаются в правильном порядке

---

## ЭТАП 5: ТЕСТИРОВАНИЕ АВТОПРОКРУТКИ

### Тест 5.1: Автопрокрутка включена

**Шаги:**
1. Включить автопрокрутку терминала в GUI
2. Выполнить длинную операцию (много сообщений)
3. Проверить, что терминал автоматически прокручивается вниз

**Ожидаемый результат:**
- ✅ Терминал автоматически прокручивается к последнему сообщению
- ✅ Обновление происходит регулярно (каждые 100мс)
- ✅ Видно последние сообщения

### Тест 5.2: Автопрокрутка выключена

**Шаги:**
1. Выключить автопрокрутку терминала в GUI
2. Выполнить операцию
3. Проверить, что терминал НЕ обновляется автоматически

**Ожидаемый результат:**
- ✅ Терминал НЕ обновляется автоматически (по дизайну)
- ✅ Пользователь может прокручивать вручную
- ✅ После включения автопрокрутки обновление возобновляется

**Критично:** Если автопрокрутка выключена, `process_terminal_queue()` НЕ должен вызывать `_update_terminal_display()`

---

## ЭТАП 6: ТЕСТИРОВАНИЕ ВОСПРОИЗВЕДЕНИЯ ЛОГА

### Тест 6.1: Загрузка существующего лога

**Шаги:**
1. В GUI выбрать "Загрузить лог" (или соответствующий пункт меню)
2. Выбрать существующий лог-файл
3. Проверить, что лог загружается в терминал

**Ожидаемый результат:**
- ✅ Лог загружается в буферы DualStreamLogger (analysis buffer)
- ✅ Терминал отображает загруженные сообщения
- ✅ Метки времени сохраняются
- ✅ Для больших файлов (>10MB) загружаются только последние 20,000 строк

### Тест 6.2: Очистка буферов при загрузке

**Шаги:**
1. Выполнить операцию, чтобы в буферах были сообщения
2. Загрузить существующий лог
3. Проверить, что старые сообщения удалены

**Ожидаемый результат:**
- ✅ Буферы очищаются перед загрузкой нового лога
- ✅ Отображаются только сообщения из загруженного лога

---

## ЭТАП 7: ТЕСТИРОВАНИЕ ФАЙЛОВОЙ ЗАПИСИ

### Тест 7.1: Асинхронная запись в файлы

**Шаги:**
1. Выполнить операцию, которая генерирует много сообщений
2. Немедленно проверить файлы логов
3. Подождать несколько секунд и проверить снова

**Ожидаемый результат:**
- ✅ Запись происходит асинхронно (не блокирует выполнение)
- ✅ Сообщения появляются в файлах с небольшой задержкой
- ✅ Все сообщения в итоге записываются

### Тест 7.2: Разделение RAW и ANALYSIS в файлы

**Шаги:**
1. Выполнить операцию
2. Проверить содержимое `*_raw.log` и `*_analysis.log`

**Ожидаемый результат:**
- ✅ RAW сообщения только в `*_raw.log`
- ✅ ANALYSIS сообщения только в `*_analysis.log`
- ✅ Нет дублирования между файлами

---

## ЭТАП 8: ИНТЕГРАЦИОННОЕ ТЕСТИРОВАНИЕ

### Тест 8.1: Полный цикл обновления системы

**Шаги:**
1. Запустить GUI
2. Выполнить полное обновление системы (через GUI)
3. Проверить все компоненты:
   - RAW поток содержит вывод apt-get
   - ANALYSIS поток содержит системные сообщения
   - GUI терминал отображает оба потока (в режиме "both")
   - Файлы логов созданы и заполнены
   - Автопрокрутка работает

**Ожидаемый результат:**
- ✅ Все компоненты работают вместе корректно
- ✅ Нет ошибок в консоли
- ✅ Нет зависаний или блокировок

### Тест 8.2: Переключение режимов во время работы

**Шаги:**
1. Запустить длинную операцию
2. Во время выполнения переключать режимы терминала ("raw" → "analysis" → "both")
3. Проверить, что переключение работает корректно

**Ожидаемый результат:**
- ✅ Переключение режимов работает без ошибок
- ✅ Отображение обновляется корректно
- ✅ Сообщения не теряются

---

## ЭТАП 9: ТЕСТИРОВАНИЕ ОШИБОК И ГРАНИЧНЫХ СЛУЧАЕВ

### Тест 9.1: Отсутствие dual_logger

**Шаги:**
1. Проверить fallback логику, если `dual_logger` недоступен
2. Проверить, что `universal_print()` использует `builtins._original_print`

**Ожидаемый результат:**
- ✅ Система не падает при отсутствии dual_logger
- ✅ Сообщения выводятся через оригинальный print

### Тест 9.2: Большой объем сообщений

**Шаги:**
1. Выполнить операцию, которая генерирует очень много сообщений (>10,000)
2. Проверить, что буферы не переполняются
3. Проверить производительность

**Ожидаемый результат:**
- ✅ Буферы ограничены размером (maxlen=10000)
- ✅ Старые сообщения удаляются автоматически
- ✅ Производительность остается приемлемой

---

## ЭТАП 10: ПРОВЕРКА УДАЛЕНИЯ СТАРОГО КОДА

### Тест 10.1: Отсутствие прямых записей в GLOBAL_LOG_FILE

**Шаги:**
1. Выполнить поиск всех использований `GLOBAL_LOG_FILE` в коде
2. Проверить, что прямые записи удалены

**Команда для проверки:**
```bash
cd /Volumes/FSA-PRJ/Project/FSA-AstraInstall
grep -n "GLOBAL_LOG_FILE" astra_automation.py | grep -v "#" | grep -v "def.*:" | grep -v "=" | grep -v "get_log_file_path"
```

**Ожидаемый результат:**
- ✅ Нет прямых записей в `GLOBAL_LOG_FILE` через `open().write()`
- ✅ `GLOBAL_LOG_FILE` используется только для инициализации и получения пути

### Тест 10.2: Отсутствие метода add_terminal_output()

**Шаги:**
1. Проверить, что метод `add_terminal_output()` удален
2. Проверить, что нет вызовов этого метода

**Команда для проверки:**
```bash
grep -n "add_terminal_output" astra_automation.py
```

**Ожидаемый результат:**
- ✅ Метод `add_terminal_output()` не найден
- ✅ Нет вызовов этого метода

---

## ЧЕКЛИСТ ДЛЯ БЫСТРОЙ ПРОВЕРКИ

### Базовые проверки (5 минут):
- [x] GUI запускается без ошибок ✅
- [x] В консоли есть сообщение `[DUAL_STREAM] OK: DualStreamLogger создан` ✅
- [x] Созданы файлы `*_raw.log` и `*_analysis.log` ✅
- [x] Терминал GUI отображает начальные сообщения ✅

### Средние проверки (15 минут):
- [x] Выполнить простую операцию (обновление репозиториев) ✅
- [x] Проверить, что терминал обновляется ✅
- [x] Проверить режимы "raw", "analysis", "both" ✅
- [x] Проверить автопрокрутку (включена/выключена) ✅
- [x] Проверить загрузку существующего лога ✅

### Полные проверки (30 минут):
- [x] Выполнить полное обновление системы ✅
- [x] Проверить все файлы логов ✅
- [x] Проверить сортировку по времени в режиме "both" ✅
- [x] Проверить переключение режимов во время работы ✅
- [x] Проверить отсутствие ошибок в консоли ✅

---

## КРИТИЧЕСКИЕ ПРОБЛЕМЫ ДЛЯ ОТСЛЕЖИВАНИЯ

1. **Терминал не обновляется:**
   - Проверить, что `dual_logger` установлен в `universal_runner`
   - Проверить, что автопрокрутка включена
   - Проверить, что `_update_terminal_display()` вызывается

2. **Сообщения не попадают в буферы:**
   - Проверить, что `universal_print()` вызывается
   - Проверить, что `dual_logger` доступен
   - Проверить логику fallback

3. **Файлы логов не создаются:**
   - Проверить, что `start_file_logging()` вызывается
   - Проверить права доступа к директории
   - Проверить пути к файлам

4. **Дублирование сообщений:**
   - Проверить, что нет прямых записей в `GLOBAL_LOG_FILE`
   - Проверить, что нет дублирования через старые методы

---

## РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ

Заполнять по мере выполнения тестов:

| Тест | Статус | Комментарии |
|------|--------|-------------|
| 1.1 Инициализация DualStreamLogger | ✅ | Работает корректно |
| 1.2 Создание лог-файлов | ✅ | Оба файла создаются |
| 2.1 Стандартный print() | ✅ | Метки времени добавляются |
| 2.2 Прямой вызов universal_print() | ✅ | Работает через параметры |
| 3.1 RAW поток | ✅ | Переносы строк исправлены |
| 3.2 ANALYSIS поток | ✅ | Уровни логов работают |
| 4.1 Чтение из буферов | ✅ | GUI читает корректно |
| 4.2 Режим "raw" | ✅ | GUI работает отлично |
| 4.3 Режим "analysis" | ✅ | GUI работает отлично |
| 4.4 Режим "both" с сортировкой | ✅ | GUI работает отлично |
| 5.1 Автопрокрутка включена | ✅ | GUI работает отлично |
| 5.2 Автопрокрутка выключена | ✅ | GUI работает отлично |
| 6.1 Загрузка лога | ✅ | GUI работает отлично |
| 6.2 Очистка буферов | ✅ | GUI работает отлично |
| 7.1 Асинхронная запись | ✅ | Работает через очередь |
| 7.2 Разделение потоков | ✅ | RAW и ANALYSIS разделены |
| 8.1 Полный цикл | ✅ | GUI работает отлично |
| 8.2 Переключение режимов | ✅ | GUI работает отлично |
| 9.1 Отсутствие dual_logger | ✅ | Fallback работает |
| 9.2 Большой объем | ⬜ | Буферы ограничены |
| 10.1 Удаление GLOBAL_LOG_FILE | ✅ | Используется только для инициализации |
| 10.2 Удаление add_terminal_output() | ✅ | Метод удален |

---

## СЛЕДУЮЩИЕ ШАГИ ПОСЛЕ ТЕСТИРОВАНИЯ

1. Если все тесты пройдены → документировать успешное завершение
2. Если есть проблемы → создать список задач для исправления
3. Провести нагрузочное тестирование на реальных операциях
4. Проверить работу на других платформах (если применимо)

