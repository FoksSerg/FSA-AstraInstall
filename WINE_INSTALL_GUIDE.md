# Руководство по установке Wine и Astra.IDE

## Обзор

Модуль автоматической установки Wine компонентов и Astra.IDE интегрирован в GUI приложения.

## Требования

### Необходимые файлы в папке `AstraPack/`:

1. **Wine пакеты:**
   - `wine_9.0-1_amd64.deb` (~52 MB)
   - `wine-astraregul_10.0-rc6-3_amd64.deb` (~59 MB)

2. **Astra.IDE:**
   - `Astra.IDE_64_1.7.2.1.exe` (~1.9 GB)

3. **Вспомогательные файлы:**
   - `winetricks` (исполняемый файл)
   - `wine-gecko/` (компоненты Gecko для Wine)
   - `winetricks-cache/` (кэш компонентов winetricks)

### Системные требования:

- Права root (для установки пакетов)
- Astra Linux
- Python 3.x
- **Свободное место на диске: минимум 4 ГБ**
- **Доступная память: минимум 1 ГБ**
- **Стабильное интернет-соединение** (для загрузки компонентов)

## Использование

### Через GUI:

1. Запустите приложение:
   ```bash
   bash astra_install.sh
   ```

2. Перейдите на вкладку "Wine & Astra.IDE"

3. Нажмите кнопку "**Проверить компоненты**" для проверки текущего состояния

4. Если компоненты не установлены, кнопка "**Установить компоненты**" станет активной

5. Нажмите "**Установить компоненты**" для запуска установки

6. Процесс установки займет 10-15 минут

7. После завершения автоматически выполнится проверка

### Что происходит во время установки:

1. **Проверка предварительных условий**
   - Наличие всех файлов в `AstraPack/`
   - Права root
   - **Проверка системных ресурсов (диск, память)**

2. **Установка Wine пакетов**
   - Wine 9.0
   - Wine Astraregul

3. **Настройка ptrace_scope**
   - Отключение блокировки ptrace (если требуется)

4. **Настройка окружения Wine**
   - Создание кэш-директорий
   - Копирование wine-gecko компонентов
   - Копирование winetricks кэша

5. **Установка компонентов winetricks**
   - dotnet48
   - vcrun2013
   - vcrun2022
   - d3dcompiler_43
   - d3dcompiler_47
   - dxvk

6. **Создание скриптов запуска**
   - `~/start-astraide.sh`

7. **Установка Astra.IDE**
   - Запуск установщика через Wine

8. **Создание ярлыка**
   - Ярлык на рабочем столе: `~/Desktop/AstraRegul.desktop`

## Компоненты проверки

После установки проверяются следующие компоненты:

| Компонент | Путь | Описание |
|-----------|------|----------|
| Wine Astraregul | `/opt/wine-astraregul/bin/wine` | Wine для Astra.IDE |
| Wine 9.0 | `/opt/wine-9.0/bin/wine` | Базовая версия Wine |
| ptrace_scope | `/proc/sys/kernel/yama/ptrace_scope` | Должно быть != 3 |
| WINEPREFIX | `~/.wine-astraregul` | Окружение Wine |
| Astra.IDE | `WINEPREFIX/drive_c/Program Files/AstraRegul` | Установленная IDE |
| Скрипт запуска | `~/start-astraide.sh` | Скрипт для запуска |
| Ярлык | `~/Desktop/AstraRegul.desktop` | Ярлык рабочего стола |

## Логирование

Все операции установки записываются в:
- **GUI лог** (вкладка "Управление")
- **Системный терминал** (вкладка "Терминал")
- **Лог-файл** (`astra_automation_YYYYMMDD_HHMMSS.log`)

## Запуск Astra.IDE после установки

После успешной установки запустить Astra.IDE можно:

1. **Через ярлык на рабочем столе:**
   - Двойной клик по "Astra IDE (Wine)"

2. **Через скрипт запуска:**
   ```bash
   ~/start-astraide.sh
   ```

3. **Вручную:**
   ```bash
   export WINEPREFIX="${HOME}/.wine-astraregul"
   export WINE=/opt/wine-astraregul/bin/wine
   export WINEDEBUG="-all"
   cd "${WINEPREFIX}/drive_c/Program Files/AstraRegul/Astra.IDE_64_*/Astra.IDE/Common"
   "${WINE}" Astra.IDE.exe
   ```

## Архитектура

### Классы:

1. **`WineComponentsChecker`**
   - Проверка наличия установленных компонентов
   - Определение отсутствующих компонентов
   - Генерация отчетов о статусе

2. **`WineInstaller`**
   - Установка Wine пакетов
   - Настройка окружения
   - Установка Astra.IDE
   - Интеграция с Logger
   - Callback для обновления GUI

3. **`AutomationGUI`**
   - Вкладка "Wine & Astra.IDE"
   - Кнопки проверки и установки
   - Отображение статуса в реальном времени
   - Автоматическое обновление после установки

### Потоки выполнения:

- **Проверка компонентов**: выполняется в отдельном потоке
- **Установка компонентов**: выполняется в отдельном потоке
- **Обновление GUI**: через `root.after()` из главного потока

## Устранение неполадок

### Ошибка: "Требуются права root"
**Решение:** Запустите приложение:
```bash
bash astra_install.sh
```

### Ошибка: "Недостаточно системных ресурсов"
**Решение:** 
1. **Недостаточно дискового пространства:**
   ```bash
   # Очистите временные файлы
   sudo apt clean && sudo apt autoclean
   
   # Удалите неиспользуемые пакеты
   sudo apt autoremove
   
   # Проверьте логи
   sudo du -sh /var/log/*
   ```

2. **Недостаточно памяти:**
   - Закройте другие приложения
   - Перезагрузите систему для освобождения памяти
   - Проверьте использование памяти: `free -h`

3. **Проверьте ресурсы в GUI:**
   - На вкладке "Wine & Astra.IDE" отображается текущее состояние ресурсов
   - Красные предупреждения указывают на недостаток ресурсов

### Ошибка: "Отсутствуют необходимые файлы"
**Решение:** Проверьте наличие всех файлов в папке `AstraPack/`

### Ошибка: "ptrace_scope = 3 (заблокирован)"
**Решение:** Отключите блокировку ptrace вручную:
```bash
sudo sysctl -w kernel.yama.ptrace_scope=0
```

### Установка зависает на winetricks
**Решение:** Дождитесь завершения (может занять до 5 минут). Проверьте логи для деталей.

### Astra.IDE не запускается
**Решение:** 
1. Проверьте все компоненты на вкладке "Wine & Astra.IDE"
2. Убедитесь что все компоненты имеют статус [OK]
3. Проверьте логи установки

### Ошибка: "page fault on read access" при установке Astra.IDE
**Причина:** Неправильная архитектура WINEPREFIX (32-bit вместо 64-bit)
**Решение:**
1. Удалите существующий WINEPREFIX:
   ```bash
   rm -rf ~/.wine-astraregul
   ```
2. Переустановите Wine компоненты через GUI
3. Система автоматически создаст WINEPREFIX с правильной архитектурой win64

### Ошибка: "packages from this path could not be installed"
**Причина:** Проблемы с временными файлами установщика
**Решение:**
1. Очистите временные файлы Wine:
   ```bash
   rm -rf ~/.cache/wine/*
   rm -rf ~/.cache/winetricks/*
   ```
2. Перезапустите установку через GUI

## Примечания

- Папка `AstraPack/` добавлена в `.gitignore` и не будет коммититься в репозиторий
- Установка занимает 10-15 минут в зависимости от системы
- **После установки потребуется ~4 ГБ дискового пространства**
- **Требуется минимум 1 ГБ свободной памяти для работы Wine**
- Не прерывайте установку принудительно
- **Проверка ресурсов выполняется автоматически перед установкой**
