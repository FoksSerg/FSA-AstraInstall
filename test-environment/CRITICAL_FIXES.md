# Критические исправления минимального winetricks

## Проблемы, которые были исправлены:

### 1. ❌ d3dcompiler_47 - "Нет такого файла или каталога"
**Проблема:** `cp: невозможно создать обычный файл '/tmp/test-wine-fix-1759996891/dosdevices/c:/windows/system32/d3dcompiler_47.dll': Нет такого файла или каталога`

**Исправления:**
- ✅ **Создание Wine директорий:** Добавлено автоматическое создание `system32` и `syswow64` директорий
- ✅ **Улучшенная функция w_try_cp_dll:** Добавлены проверки существования файлов и директорий
- ✅ **Автоматическое создание директорий:** Функция теперь создает директории назначения если они не существуют

### 2. ❌ dxvk - "Это не каталог" для win32
**Проблема:** `cp: не удалось выполнить stat для '/dev/null/d3d11.dll': Это не каталог`

**Исправления:**
- ✅ **Исправлена логика для win32:** Для win32 архитектуры копируются только x32 DLL в system32
- ✅ **Убраны попытки копирования в /dev/null:** Для win32 не пытаемся копировать в W_SYSTEM64_DLLS
- ✅ **Добавлены информативные сообщения:** Четко показывается, что происходит для каждой архитектуры

## Новые возможности:

### ✅ Автоматическое создание Wine структуры
```bash
# Создаем необходимые директории Wine
w_info "Creating Wine directories..."
w_try mkdir -p "${W_SYSTEM32_DLLS}"
if [ "${W_ARCH}" = "win64" ]; then
    w_try mkdir -p "${W_SYSTEM64_DLLS}"
fi
```

### ✅ Улучшенная функция w_try_cp_dll
```bash
# Проверяем существование исходного файла
if [ ! -f "${source}" ]; then
    w_warn "Source file not found: ${source}"
    return 1
fi

# Создаем директорию назначения если не существует
local dest_dir=$(dirname "${dest}")
if [ ! -d "${dest_dir}" ]; then
    w_info "Creating directory: ${dest_dir}"
    w_try mkdir -p "${dest_dir}"
fi
```

### ✅ Правильная логика для разных архитектур
```bash
if [ "${W_ARCH}" = "win64" ]; then
    # Для win64: копируем x64 DLL в system32, x32 DLL в syswow64
    w_info "Copying DXVK DLLs for win64..."
    w_try_cp_dll "dxvk-2.5.3/x64/d3d11.dll" "${W_SYSTEM64_DLLS}/d3d11.dll"
    w_try_cp_dll "dxvk-2.5.3/x64/dxgi.dll" "${W_SYSTEM64_DLLS}/dxgi.dll"
    w_try_cp_dll "dxvk-2.5.3/x32/d3d11.dll" "${W_SYSTEM32_DLLS}/d3d11.dll"
    w_try_cp_dll "dxvk-2.5.3/x32/dxgi.dll" "${W_SYSTEM32_DLLS}/dxgi.dll"
else
    # Для win32: копируем только x32 DLL в system32
    w_info "Copying DXVK DLLs for win32..."
    w_try_cp_dll "dxvk-2.5.3/x32/d3d11.dll" "${W_SYSTEM32_DLLS}/d3d11.dll"
    w_try_cp_dll "dxvk-2.5.3/x32/dxgi.dll" "${W_SYSTEM32_DLLS}/dxgi.dll"
fi
```

## Тестирование:

Для тестирования критических исправлений:
```bash
cd test-environment
./test_critical_fixes.sh
```

Этот тест проверит только критические исправления:
- d3dcompiler_47 (должен работать)
- dxvk (должен работать для win32)

## Ожидаемые результаты:

После критических исправлений должны работать:
- ✅ **d3dcompiler_47** - исправлено создание директорий
- ✅ **dxvk** - исправлена логика для win32
- ✅ **vcrun2013** - уже работал
- ⚠️ **dotnet48** - может потребовать дополнительных настроек
- ⚠️ **vcrun2022** - нужно проверить
- ⚠️ **d3dcompiler_43** - нужно проверить

## Ключевые улучшения:

1. **Автоматическое создание Wine структуры** - больше не нужно вручную создавать директории
2. **Правильная обработка win32/win64** - корректная логика для разных архитектур
3. **Улучшенная диагностика** - более информативные сообщения об ошибках
4. **Надежное копирование файлов** - проверки существования и создание директорий

## Следующие шаги:

После успешного тестирования критических исправлений:
1. Протестировать все компоненты
2. Интегрировать в основной проект
3. Заменить оригинальный winetricks на минимальный
